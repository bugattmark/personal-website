<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>letters to myself.</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #ffffff;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 80px;
        }

        .header h1 {
            font-size: 11px;
            font-weight: 200;
            letter-spacing: 2px;
            color: #000000;
        }

        .entries {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        .entry-block {
            position: relative;
        }

        .entry {
            width: 100%;
            font-size: 16px;
            font-weight: 300;
            line-height: 1.8;
            color: #1a1a1a;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .entry a {
            color: #0066cc;
            text-decoration: none;
        }

        .entry a:hover {
            text-decoration: underline;
        }

        .entry .math-block {
            display: block;
            text-align: center;
            margin: 10px 0;
            white-space: normal;
        }

        .entry .math-inline {
            white-space: normal;
        }

        .entry-time {
            font-size: 9px;
            font-weight: 200;
            color: #999;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .entry-actions {
            display: none;
            position: absolute;
            top: 0;
            right: 0;
            gap: 10px;
        }

        .entry-actions.visible {
            display: flex;
        }

        .entry-actions button {
            background: none;
            border: none;
            font-size: 9px;
            font-weight: 200;
            color: #ccc;
            cursor: pointer;
            letter-spacing: 1px;
        }

        .entry-actions button:hover {
            color: #999;
        }

        .input-area {
            display: none;
            margin-bottom: 60px;
        }

        .input-area.visible {
            display: block;
        }

        .input-box {
            width: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            font-weight: 300;
            line-height: 1.8;
            color: #1a1a1a;
            font-family: inherit;
            resize: none;
            background: transparent;
            min-height: 100px;
        }

        .input-box::placeholder {
            color: #ccc;
            font-weight: 200;
        }

        .post-hint {
            font-size: 9px;
            font-weight: 200;
            color: #ccc;
            margin-top: 10px;
            letter-spacing: 1px;
        }

        .entry-edit {
            width: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            font-weight: 300;
            line-height: 1.8;
            color: #1a1a1a;
            font-family: inherit;
            resize: none;
            background: transparent;
            display: none;
        }

        .entry-edit.visible {
            display: block;
        }

        .entry.hidden {
            display: none;
        }

        .auth-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .auth-prompt:hover {
            opacity: 1;
        }

        .auth-prompt.hidden {
            display: none;
        }

        .auth-prompt input {
            border: none;
            border-bottom: 1px solid #eee;
            outline: none;
            font-size: 10px;
            font-weight: 200;
            padding: 5px;
            background: transparent;
            width: 120px;
        }

        .auth-prompt input::placeholder {
            color: #ddd;
        }

        .divider {
            height: 1px;
            background: #f5f5f5;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>letters to myself.</h1>
        </div>

        <div class="input-area" id="inputArea">
            <textarea class="input-box" id="inputBox" placeholder="write something..."></textarea>
            <div class="post-hint">press enter twice to post</div>
            <div class="divider" style="margin-top: 40px;"></div>
        </div>

        <div class="entries" id="entries"></div>
    </div>

    <div class="auth-prompt" id="authPrompt">
        <input type="password" id="authInput" placeholder="">
    </div>

    <script>
        (function() {
            const SUPABASE_URL = 'https://ssaelytfcwysguyjujsz.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzYWVseXRmY3d5c2d1eWp1anN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MTUwODEsImV4cCI6MjA4MTI5MTA4MX0.utwtoyxvu1BDgPm19xhEc1rn2gXPRgfvJsHfi8b2Q8E';

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            let authenticated = false;
            let entries = [];

            async function hashPassphrase(passphrase) {
                const encoder = new TextEncoder();
                const data = encoder.encode(passphrase + 'letters_salt_2024');
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // Parse text for links, math, and preserve emojis
            function parseText(text) {
                // First escape HTML
                let result = escapeHtml(text);

                // Parse block math $$...$$ first
                result = result.replace(/\$\$([^$]+)\$\$/g, function(match, math) {
                    try {
                        return '<span class="math-block">' + katex.renderToString(math, { displayMode: true, throwOnError: false }) + '</span>';
                    } catch (e) {
                        return match;
                    }
                });

                // Parse inline math $...$
                result = result.replace(/\$([^$]+)\$/g, function(match, math) {
                    try {
                        return '<span class="math-inline">' + katex.renderToString(math, { displayMode: false, throwOnError: false }) + '</span>';
                    } catch (e) {
                        return match;
                    }
                });

                // Parse links (text)[url]
                result = result.replace(/\(([^)]+)\)\[([^\]]+)\]/g, function(match, text, url) {
                    // Basic URL validation
                    if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('mailto:')) {
                        return '<a href="' + url + '" target="_blank" rel="noopener noreferrer">' + text + '</a>';
                    }
                    return '<a href="https://' + url + '" target="_blank" rel="noopener noreferrer">' + text + '</a>';
                });

                return result;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async function loadEntries() {
                const { data, error } = await supabase
                    .from('entries')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (!error && data) {
                    entries = data;
                    renderEntries();
                }
            }

            function renderEntries() {
                const container = document.getElementById('entries');
                container.innerHTML = '';

                entries.forEach((entry, index) => {
                    const block = document.createElement('div');
                    block.className = 'entry-block';
                    block.innerHTML = `
                        <div class="entry-actions ${authenticated ? 'visible' : ''}" data-id="${entry.id}">
                            <button onclick="editEntry(${entry.id}, ${index})">edit</button>
                            <button onclick="deleteEntry(${entry.id})">delete</button>
                        </div>
                        <div class="entry-time">${entry.time}</div>
                        <div class="entry" id="entry-text-${index}">${parseText(entry.text)}</div>
                        <textarea class="entry-edit" id="entry-edit-${index}">${entry.text}</textarea>
                    `;
                    container.appendChild(block);

                    const divider = document.createElement('div');
                    divider.className = 'divider';
                    divider.style.marginTop = '20px';
                    container.appendChild(divider);
                });
            }

            async function saveEntry(text) {
                const now = new Date();
                const time = now.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).toLowerCase();

                const { error } = await supabase
                    .from('entries')
                    .insert([{ text, time }]);

                if (!error) {
                    await loadEntries();
                }
            }

            window.editEntry = async function(id, index) {
                if (!authenticated) return;

                const textEl = document.getElementById(`entry-text-${index}`);
                const editEl = document.getElementById(`entry-edit-${index}`);

                textEl.classList.add('hidden');
                editEl.classList.add('visible');
                editEl.focus();

                editEl.style.height = 'auto';
                editEl.style.height = editEl.scrollHeight + 'px';

                editEl.onblur = async function() {
                    const { error } = await supabase
                        .from('entries')
                        .update({ text: editEl.value })
                        .eq('id', id);

                    if (!error) {
                        await loadEntries();
                    }
                };

                editEl.onkeydown = function(e) {
                    if (e.key === 'Escape') {
                        loadEntries();
                    }
                };
            };

            window.deleteEntry = async function(id) {
                if (!authenticated) return;

                const { error } = await supabase
                    .from('entries')
                    .delete()
                    .eq('id', id);

                if (!error) {
                    await loadEntries();
                }
            };

            function updateUI() {
                if (authenticated) {
                    document.getElementById('inputArea').classList.add('visible');
                    document.getElementById('authPrompt').classList.add('hidden');
                    document.querySelectorAll('.entry-actions').forEach(el => {
                        el.classList.add('visible');
                    });
                }
            }

            document.getElementById('authInput').addEventListener('keydown', async function(e) {
                if (e.key === 'Enter') {
                    const hash = await hashPassphrase(this.value);
                    const storedHash = localStorage.getItem('letters_hash');

                    if (!storedHash) {
                        localStorage.setItem('letters_hash', hash);
                        authenticated = true;
                        updateUI();
                    } else if (hash === storedHash) {
                        authenticated = true;
                        updateUI();
                    }

                    this.value = '';
                }
            });

            let lastEnter = 0;
            document.getElementById('inputBox').addEventListener('keydown', async function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    const now = Date.now();
                    if (now - lastEnter < 500 && this.value.trim()) {
                        e.preventDefault();
                        const text = this.value.trim().replace(/\n$/, '');
                        await saveEntry(text);
                        this.value = '';
                        lastEnter = 0;
                    } else {
                        lastEnter = now;
                    }
                }
            });

            loadEntries();
        })();
    </script>
</body>
</html>
